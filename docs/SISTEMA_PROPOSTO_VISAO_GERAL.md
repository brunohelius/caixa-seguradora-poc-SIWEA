# Sistema Proposto: Migra√ß√£o SIWEA para .NET 9 + React

**Projeto:** Moderniza√ß√£o do Sistema de Libera√ß√£o de Pagamento de Sinistros
**Vers√£o:** 1.0
**Data:** 2025-10-27
**Dura√ß√£o do Projeto:** 3 meses (13 semanas)
**Status:** Planejamento

---

## √çndice

1. [Vis√£o Executiva](#vis√£o-executiva)
2. [Arquitetura do Sistema Proposto](#arquitetura-do-sistema-proposto)
3. [Stack Tecnol√≥gico](#stack-tecnol√≥gico)
4. [Funcionalidades Detalhadas](#funcionalidades-detalhadas)
5. [Comparativo: Legado vs Proposto](#comparativo-legado-vs-proposto)

---

## 1. Vis√£o Executiva

### 1.1 Objetivo do Projeto

Migrar o sistema legado SIWEA (IBM VisualAge EZEE 4.40 em mainframe CICS) para uma arquitetura moderna baseada em:
- **Backend:** .NET 9 com Clean Architecture
- **Frontend:** React 19 + TypeScript
- **Cloud:** Microsoft Azure (ou on-premises compat√≠vel)

### 1.2 Justificativa

**Problemas do Sistema Atual:**
- ‚ö†Ô∏è Plataforma mainframe obsoleta (35+ anos)
- üí∞ Alto custo de manuten√ß√£o e licenciamento CICS
- üë• Escassez de profissionais COBOL/EZEE
- üîß Dificuldade de evolu√ß√£o e manuten√ß√£o
- üì± Interface n√£o responsiva (terminais 3270)
- üîå Integra√ß√£o limitada com sistemas modernos

**Benef√≠cios da Migra√ß√£o:**
- ‚úÖ Redu√ß√£o de custos operacionais (estimado: 40-60%)
- ‚úÖ Stack tecnol√≥gico moderno e amplamente adotado
- ‚úÖ Interface web responsiva (desktop + mobile)
- ‚úÖ Facilidade de integra√ß√£o (APIs REST/SOAP)
- ‚úÖ Melhor performance e escalabilidade
- ‚úÖ Facilidade de recrutamento de talentos
- ‚úÖ Base para futuras inova√ß√µes (IA, analytics, etc)

### 1.3 Escopo do Projeto

**DENTRO DO ESCOPO:**
- ‚úÖ Migra√ß√£o completa das 6 User Stories (100% funcionalidade)
- ‚úÖ Preserva√ß√£o de 100% das regras de neg√≥cio
- ‚úÖ Migra√ß√£o de dados hist√≥ricos (sinistros, pagamentos)
- ‚úÖ Interface web responsiva (preservando Site.css)
- ‚úÖ Integra√ß√µes externas (CNOUA, SIPUA, SIMDA)
- ‚úÖ Testes automatizados (unit√°rios, integra√ß√£o, E2E)
- ‚úÖ Documenta√ß√£o completa (t√©cnica e usu√°rio)
- ‚úÖ Treinamento de operadores
- ‚úÖ Cutover e go-live

**FORA DO ESCOPO:**
- ‚ùå Modifica√ß√£o de regras de neg√≥cio
- ‚ùå Novos recursos al√©m dos existentes
- ‚ùå Migra√ß√£o de outros sistemas al√©m do SIWEA
- ‚ùå Redesenho de processos de neg√≥cio
- ‚ùå Mudan√ßa de sistemas externos (CNOUA, SIPUA, SIMDA)

### 1.4 M√©tricas de Sucesso

| M√©trica | Meta |
|---------|------|
| **Paridade Funcional** | 100% das funcionalidades migradas |
| **Paridade de Regras** | 100% das 100 regras de neg√≥cio |
| **Performance** | Busca < 3s, Autoriza√ß√£o < 90s |
| **Disponibilidade** | 99.5% durante hor√°rio comercial |
| **Acur√°cia de Dados** | 100% dos c√°lculos id√™nticos ao legado |
| **Ado√ß√£o de Usu√°rios** | 95% dos operadores sem treinamento adicional |
| **Prazo** | 3 meses (13 semanas) |
| **Or√ßamento** | Dentro do budget aprovado |

---

## 2. Arquitetura do Sistema Proposto

### 2.1 Vis√£o de Alto N√≠vel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         FRONTEND LAYER                          ‚îÇ
‚îÇ                    React 19 + TypeScript                        ‚îÇ
‚îÇ                          Vite 7.1                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üì± Aplica√ß√£o SPA                                               ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimSearch.tsx          (Busca de sinistros)              ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimDetails.tsx         (Detalhes e autoriza√ß√£o)          ‚îÇ
‚îÇ  ‚îú‚îÄ PaymentHistory.tsx       (Hist√≥rico de pagamentos)         ‚îÇ
‚îÇ  ‚îú‚îÄ PhaseTimeline.tsx        (Fases do workflow)               ‚îÇ
‚îÇ  ‚îî‚îÄ MigrationDashboard.tsx   (Dashboard de migra√ß√£o)           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üé® Componentes UI                                              ‚îÇ
‚îÇ  ‚îú‚îÄ Site.css (preservado 100%)                                 ‚îÇ
‚îÇ  ‚îú‚îÄ Formul√°rios com valida√ß√£o em tempo real                    ‚îÇ
‚îÇ  ‚îú‚îÄ Mensagens de erro em portugu√™s                             ‚îÇ
‚îÇ  ‚îî‚îÄ Design responsivo (desktop + mobile)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ HTTPS / JSON
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         API LAYER                               ‚îÇ
‚îÇ                   ASP.NET Core 9.0 Web API                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üåê REST Endpoints                                              ‚îÇ
‚îÇ  ‚îú‚îÄ GET  /api/claims/search                                    ‚îÇ
‚îÇ  ‚îú‚îÄ POST /api/claims/authorize-payment                         ‚îÇ
‚îÇ  ‚îú‚îÄ GET  /api/claims/{id}/history                              ‚îÇ
‚îÇ  ‚îî‚îÄ GET  /api/claims/{id}/phases                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üßº SOAP Endpoints (SoapCore)                                   ‚îÇ
‚îÇ  ‚îú‚îÄ /soap/autenticacao      (compatibilidade legado)           ‚îÇ
‚îÇ  ‚îú‚îÄ /soap/solicitacao        (compatibilidade legado)          ‚îÇ
‚îÇ  ‚îî‚îÄ /soap/assunto            (compatibilidade legado)          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üõ°Ô∏è Middleware                                                  ‚îÇ
‚îÇ  ‚îú‚îÄ GlobalExceptionHandler                                     ‚îÇ
‚îÇ  ‚îú‚îÄ AuthenticationMiddleware (JWT)                             ‚îÇ
‚îÇ  ‚îú‚îÄ RequestLoggingMiddleware (Serilog)                         ‚îÇ
‚îÇ  ‚îî‚îÄ ValidationMiddleware (FluentValidation)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ In-Process
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CORE LAYER                              ‚îÇ
‚îÇ                      (Business Logic)                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üíº Domain Services                                             ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimService                                                ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ SearchClaims() - 3 modos de busca                       ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ GetClaimDetails() - recupera√ß√£o completa                ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îú‚îÄ PaymentAuthorizationService                                ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ ValidatePayment() - BR-010 a BR-022                     ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ ExecuteAuthorization() - pipeline 8 etapas              ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ RollbackOnFailure() - atomicidade                       ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îú‚îÄ CurrencyConversionService                                  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ GetConversionRate() - TGEUNIMO lookup                   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ ConvertToBTNF() - BR-023 f√≥rmula                        ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ CalculateTotals() - BR-029, BR-030, BR-031              ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îú‚îÄ PhaseManagementService                                     ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ DeterminePhaseChanges() - SI_REL_FASE_EVENTO            ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ OpenPhase() - DATA_FECHA_SIFA='9999-12-31'              ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ ClosePhase() - atualiza data fechamento                 ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îî‚îÄ ExternalValidationService                                  ‚îÇ
‚îÇ     ‚îú‚îÄ RouteValidation() - CNOUA/SIPUA/SIMDA                   ‚îÇ
‚îÇ     ‚îî‚îÄ ValidateProduct() - c√≥digos de erro                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üìã Domain Entities (13 entidades)                             ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimMaster, ClaimHistory, BranchMaster                    ‚îÇ
‚îÇ  ‚îú‚îÄ PolicyMaster, CurrencyUnit, SystemControl                  ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimAccompaniment, ClaimPhase, PhaseEventRelationship    ‚îÇ
‚îÇ  ‚îî‚îÄ ConsortiumContract, MigrationStatus, ComponentMigration   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚úÖ Validators (FluentValidation)                               ‚îÇ
‚îÇ  ‚îî‚îÄ 100+ regras de neg√≥cio implementadas                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ In-Process
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    INFRASTRUCTURE LAYER                         ‚îÇ
‚îÇ                  (Data Access + External)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üíæ Data Access                                                 ‚îÇ
‚îÇ  ‚îú‚îÄ ClaimsDbContext (EF Core 9)                                ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Database-first approach                                 ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Fluent API para mapeamento legado                       ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Connection pooling                                      ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îú‚îÄ Repository Pattern                                         ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ ClaimRepository                                         ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ PaymentHistoryRepository                                ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ PhaseRepository                                         ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ CurrencyRateRepository                                  ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îî‚îÄ Unit of Work                                                ‚îÇ
‚îÇ     ‚îî‚îÄ Transaction management (BEGIN/COMMIT/ROLLBACK)           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üîå External Service Clients                                    ‚îÇ
‚îÇ  ‚îú‚îÄ CNOUAClient (REST API)                                      ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ HttpClient com Polly                                    ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ Retry policy (3x exponential backoff)                   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ Circuit breaker (5 failures ‚Üí 30s break)                ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îú‚îÄ SIPUAClient (SOAP)                                          ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ SoapClient com Polly                                    ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îî‚îÄ SIMDAClient (SOAP)                                          ‚îÇ
‚îÇ     ‚îî‚îÄ SoapClient com Polly                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚îÇ ADO.NET / SOAP
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    EXTERNAL SYSTEMS                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üóÑÔ∏è  Database (SQL Server ou DB2)                              ‚îÇ
‚îÇ  ‚îú‚îÄ 10 tabelas legadas (schema preservado)                     ‚îÇ
‚îÇ  ‚îî‚îÄ 3 tabelas novas (migration tracking)                       ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  üîó External Services                                           ‚îÇ
‚îÇ  ‚îú‚îÄ CNOUA (Consortium Validation)                              ‚îÇ
‚îÇ  ‚îú‚îÄ SIPUA (EFP Contract Validation)                            ‚îÇ
‚îÇ  ‚îî‚îÄ SIMDA (HB Contract Validation)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 Padr√µes Arquiteturais

#### **Clean Architecture**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Presentation Layer              ‚îÇ
‚îÇ         (Controllers, DTOs)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ Depende de ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Application Layer               ‚îÇ
‚îÇ    (Use Cases, Business Logic)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ Depende de ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           Domain Layer                  ‚îÇ
‚îÇ      (Entities, Interfaces)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ Implementado por ‚Üë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       Infrastructure Layer              ‚îÇ
‚îÇ  (EF Core, External Clients, DB)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Benef√≠cios:**
- ‚úÖ Testabilidade: Core layer independente de infraestrutura
- ‚úÖ Manutenibilidade: Separa√ß√£o clara de responsabilidades
- ‚úÖ Flexibilidade: F√°cil trocar banco ou frameworks

#### **Repository Pattern**
```csharp
public interface IClaimRepository
{
    Task<ClaimMaster?> GetByProtocolAsync(int fonte, int protsini, int dac);
    Task<ClaimMaster?> GetByClaimNumberAsync(int orgsin, int rmosin, int numsin);
    Task<ClaimMaster?> GetByLeaderCodeAsync(int codlider, int sinlid);
    Task UpdateAsync(ClaimMaster claim);
}
```

#### **Unit of Work Pattern**
```csharp
public interface IUnitOfWork : IDisposable
{
    IClaimRepository Claims { get; }
    IPaymentHistoryRepository PaymentHistory { get; }
    IPhaseRepository Phases { get; }

    Task<int> SaveChangesAsync();
    Task<IDbContextTransaction> BeginTransactionAsync();
}
```

---

## 3. Stack Tecnol√≥gico

### 3.1 Backend (.NET 9)

| Componente | Tecnologia | Vers√£o | Prop√≥sito |
|------------|------------|--------|-----------|
| **Framework** | .NET | 9.0 | Runtime e APIs |
| **Web Framework** | ASP.NET Core | 9.0 | Web API |
| **ORM** | Entity Framework Core | 9.0 | Acesso a dados |
| **SOAP Support** | SoapCore | 1.1.0 | Endpoints SOAP legados |
| **Validation** | FluentValidation | 11.9.0 | Valida√ß√£o de regras |
| **Mapping** | AutoMapper | 12.0.1 | Mapeamento DTO ‚Üî Entity |
| **Logging** | Serilog | 4.0.0 | Logging estruturado |
| **Resilience** | Polly | 8.2.0 | Retry, circuit breaker |
| **Authentication** | Microsoft.Identity | 9.0 | JWT tokens |
| **Testing** | xUnit | 2.6.0 | Testes unit√°rios |
| **Mocking** | Moq | 4.20.0 | Mocks para testes |
| **Database** | SQL Server | 2022 | Banco de dados principal |
| **Database (Alt)** | IBM DB2 | 11.5 | Compatibilidade legado |

**Justificativas:**
- **.NET 9:** LTS, performance, suporte Microsoft at√© Nov 2028
- **EF Core:** Produtividade, migrations, LINQ
- **SoapCore:** Compatibilidade com integra√ß√µes legadas SOAP
- **Polly:** Resili√™ncia para chamadas externas (CNOUA, SIPUA, SIMDA)

### 3.2 Frontend (React 19)

| Componente | Tecnologia | Vers√£o | Prop√≥sito |
|------------|------------|--------|-----------|
| **Framework** | React | 19.1.1 | UI library |
| **Language** | TypeScript | 5.9 | Type safety |
| **Build Tool** | Vite | 7.1.7 | Build e dev server |
| **Router** | React Router DOM | 7.9.4 | Navega√ß√£o SPA |
| **HTTP Client** | Axios | 1.12.2 | Chamadas API |
| **State/Data** | TanStack React Query | 5.90.5 | Cache e sincroniza√ß√£o |
| **Forms** | React Hook Form | 7.50.0 | Gerenciamento forms |
| **Validation** | Zod | 3.22.0 | Valida√ß√£o schemas |
| **Charts** | Recharts | 3.3.0 | Dashboard visualiza√ß√£o |
| **Date** | date-fns | 3.0.0 | Manipula√ß√£o datas |
| **Testing** | Jest | 29.7.0 | Testes unit√°rios |
| **Testing** | React Testing Library | 14.0.0 | Testes componentes |
| **E2E** | Playwright | 1.40.0 | Testes end-to-end |

**Justificativas:**
- **React 19:** Concurrent features, server components
- **TypeScript:** Type safety, IntelliSense, refatora√ß√£o segura
- **Vite:** Build r√°pido, HMR instant√¢neo
- **React Query:** Cache inteligente, invalida√ß√£o autom√°tica
- **Playwright:** E2E confi√°vel, cross-browser

### 3.3 DevOps e Infraestrutura

| Componente | Tecnologia | Prop√≥sito |
|------------|------------|-----------|
| **Containerization** | Docker | 24.0 | Containeriza√ß√£o aplica√ß√£o |
| **Orchestration** | Docker Compose | 2.0 | Dev environment |
| **CI/CD** | Azure DevOps / GitHub Actions | Pipeline automa√ß√£o |
| **Cloud** | Microsoft Azure | Hosting produ√ß√£o |
| **CDN** | Azure CDN | Frontend delivery |
| **Monitoring** | Application Insights | APM e logging |
| **Secrets** | Azure Key Vault | Gerenciamento secrets |
| **Database** | Azure SQL Database | Banco gerenciado |
| **API Gateway** | Azure API Management | Seguran√ßa APIs |

**Alternativa On-Premises:**
- Windows Server 2022
- IIS 10
- SQL Server 2022
- Self-hosted monitoring (Grafana + Prometheus)

---

## 4. Funcionalidades Detalhadas

### 4.1 User Story 1: Busca e Recupera√ß√£o de Sinistros

**Prioridade:** P1 (MVP - Must Have)
**Complexidade:** M√©dia
**Pontos de Fun√ß√£o:** 12 PF

#### Funcionalidades

**F1.1: Busca por Protocolo**
- **Entrada:** FONTE (3 d√≠gitos) + PROTSINI (7 d√≠gitos) + DAC (1 d√≠gito)
- **Formato:** 001/0123456-7
- **Query:** `SELECT * FROM TMESTSIN WHERE FONTE=? AND PROTSINI=? AND DAC=?`
- **Valida√ß√£o:** Campos num√©ricos, todos obrigat√≥rios
- **Resposta:** 0 ou 1 sinistro (protocolo √∫nico)
- **Tempo:** < 3 segundos

**F1.2: Busca por N√∫mero do Sinistro**
- **Entrada:** ORGSIN (2 d√≠gitos) + RMOSIN (2 d√≠gitos) + NUMSIN (6 d√≠gitos)
- **Formato:** 10/20/789012
- **Query:** `SELECT * FROM TMESTSIN WHERE ORGSIN=? AND RMOSIN=? AND NUMSIN=?`
- **Valida√ß√£o:** Campos num√©ricos, todos obrigat√≥rios
- **Resposta:** 0 ou 1 sinistro (n√∫mero √∫nico)

**F1.3: Busca por C√≥digo L√≠der**
- **Entrada:** CODLIDER (3 d√≠gitos) + SINLID (7 d√≠gitos)
- **Formato:** 001/0000001
- **Query:** `SELECT * FROM TMESTSIN WHERE CODLIDER=? AND SINLID=?`
- **Valida√ß√£o:** Campos num√©ricos, ambos obrigat√≥rios
- **Resposta:** 0 ou mais sinistros

**F1.4: Exibi√ß√£o de Dados Completos**
- **Protocolo:** FONTE/PROTSINI-DAC
- **Sinistro:** ORGSIN/RMOSIN/NUMSIN
- **Ap√≥lice:** ORGAPO/RMOAPO/NUMAPOL
- **Ramo:** NOMERAMO (join com TGERAMO)
- **Segurado:** NOME (join com TAPOLICE)
- **Saldo a Pagar:** SDOPAG (formatado R$ #.###,##)
- **Total Pago:** TOTPAG (formatado)
- **Saldo Pendente:** SDOPAG - TOTPAG (calculado)
- **Tipo Seguro:** TPSEGU
- **Produto:** CODPRODU

**F1.5: Tratamento de Erros**
- Sinistro n√£o encontrado ‚Üí "PROTOCOLO XXX NAO ENCONTRADO"
- Erro de conex√£o ‚Üí "Erro ao conectar ao banco de dados"
- Timeout ‚Üí "Tempo de busca excedido"

#### Interface (React)

**Componente:** `ClaimSearch.tsx`

```tsx
interface SearchCriteria {
  mode: 'protocol' | 'claim' | 'leader';
  protocol?: { fonte: string; protsini: string; dac: string };
  claim?: { orgsin: string; rmosin: string; numsin: string };
  leader?: { codlider: string; sinlid: string };
}

// Valida√ß√£o em tempo real
const schema = z.object({
  mode: z.enum(['protocol', 'claim', 'leader']),
  // ... valida√ß√µes por modo
});

// Hook React Query
const { data, isLoading, error } = useQuery({
  queryKey: ['claim', criteria],
  queryFn: () => claimService.search(criteria),
  enabled: isValid,
});
```

**Layout:**
- 3 se√ß√µes colaps√°veis (accordion)
- Radio button para selecionar modo
- Valida√ß√£o em tempo real (campo vermelho se inv√°lido)
- Bot√£o "Pesquisar" desabilitado at√© formul√°rio v√°lido
- Loading spinner durante busca
- Erro exibido em vermelho (#e80c4d)

#### Backend (.NET)

**Controller:** `ClaimsController.cs`

```csharp
[ApiController]
[Route("api/claims")]
public class ClaimsController : ControllerBase
{
    [HttpGet("search")]
    [ProducesResponseType(typeof(ClaimDetailsDto), 200)]
    [ProducesResponseType(404)]
    public async Task<ActionResult<ClaimDetailsDto>> Search(
        [FromQuery] SearchClaimQuery query)
    {
        var result = await _mediator.Send(query);
        return result.IsSuccess
            ? Ok(result.Value)
            : NotFound(result.Error);
    }
}
```

**Service:** `ClaimService.cs`

```csharp
public async Task<Result<ClaimDetailsDto>> SearchAsync(
    SearchCriteria criteria)
{
    // BR-001: Validar crit√©rio mutuamente exclusivo
    // BR-002: Ao menos um crit√©rio completo

    ClaimMaster? claim = criteria.Mode switch
    {
        SearchMode.Protocol => await _repo.GetByProtocolAsync(...),
        SearchMode.Claim => await _repo.GetByClaimNumberAsync(...),
        SearchMode.Leader => await _repo.GetByLeaderCodeAsync(...),
        _ => null
    };

    if (claim == null)
        return Result.Failure<ClaimDetailsDto>("BR-006: Sinistro n√£o encontrado");

    // BR-007: Recuperar nome do ramo
    // BR-008: Recuperar nome do segurado
    // BR-009: Formatar valores monet√°rios

    return Result.Success(_mapper.Map<ClaimDetailsDto>(claim));
}
```

#### Testes

**Unit√°rios:**
- ‚úÖ Busca por protocolo v√°lido retorna sinistro
- ‚úÖ Busca por protocolo inv√°lido retorna 404
- ‚úÖ Busca por n√∫mero de sinistro funciona
- ‚úÖ Busca por l√≠der retorna m√∫ltiplos resultados
- ‚úÖ Valida√ß√£o de campos obrigat√≥rios
- ‚úÖ Formata√ß√£o de valores monet√°rios

**Integra√ß√£o:**
- ‚úÖ Query no banco retorna dados corretos
- ‚úÖ Joins com TGERAMO e TAPOLICE funcionam
- ‚úÖ Timeout de 3 segundos √© respeitado

**E2E (Playwright):**
- ‚úÖ Usu√°rio pode buscar por protocolo e ver resultados
- ‚úÖ Mensagem de erro exibida quando n√£o encontrado
- ‚úÖ Loading spinner aparece durante busca

---

### 4.2 User Story 2: Autoriza√ß√£o de Pagamento

**Prioridade:** P2 (Core - Must Have)
**Complexidade:** Alta
**Pontos de Fun√ß√£o:** 35 PF

#### Funcionalidades

**F2.1: Formul√°rio de Autoriza√ß√£o**

**Campos de Entrada:**
1. **Tipo de Pagamento** (obrigat√≥rio)
   - Tipo: Select
   - Valores: 1, 2, 3, 4, 5
   - Valida√ß√£o: BR-010, BR-011

2. **Tipo de Ap√≥lice** (obrigat√≥rio)
   - Tipo: Select
   - Valores: 1, 2
   - Valida√ß√£o: BR-015, BR-016

3. **Valor Principal** (obrigat√≥rio)
   - Tipo: Decimal input
   - Formato: R$ #.###,##
   - Valida√ß√£o: BR-012, BR-013 (‚â§ saldo pendente)
   - M√°scara: currency input

4. **Valor Corre√ß√£o** (opcional)
   - Tipo: Decimal input
   - Formato: R$ #.###,##
   - Default: 0,00
   - Valida√ß√£o: BR-017, BR-018

5. **Benefici√°rio** (condicional)
   - Tipo: Text input
   - Max: 255 caracteres
   - Obrigat√≥rio: SE TPSEGU ‚â† 0
   - Valida√ß√£o: BR-019, BR-020, BR-021, BR-022

**F2.2: Pipeline de Autoriza√ß√£o (8 Etapas)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 1: Valida√ß√£o de Entrada                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Validar tipo pagamento (1-5)                             ‚îÇ
‚îÇ  ‚Ä¢ Validar tipo ap√≥lice (1-2)                               ‚îÇ
‚îÇ  ‚Ä¢ Validar valor principal > 0                              ‚îÇ
‚îÇ  ‚Ä¢ Validar valor ‚â§ saldo pendente                           ‚îÇ
‚îÇ  ‚Ä¢ Validar benefici√°rio (se TPSEGU ‚â† 0)                     ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí Retornar erro, ABORTAR                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 2: Obter Data Comercial e Taxa de Convers√£o         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Query TSISTEMA.DTMOVABE (WHERE IDSISTEM='SI')            ‚îÇ
‚îÇ  ‚Ä¢ Query TGEUNIMO.VLCRUZAD (WHERE date BETWEEN ...)         ‚îÇ
‚îÇ  ‚Ä¢ Validar taxa encontrada                                  ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí "Taxa n√£o dispon√≠vel", ABORTAR                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 3: C√°lculo de Convers√£o BTNF                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ VALPRIBT = VALPRI √ó VLCRUZAD (8 decimais)                ‚îÇ
‚îÇ  ‚Ä¢ CRRMONBT = CRRMON √ó VLCRUZAD                             ‚îÇ
‚îÇ  ‚Ä¢ VALTOTBT = VALPRIBT + CRRMONBT                           ‚îÇ
‚îÇ  ‚Ä¢ Arredondar para 2 decimais (Banker's Rounding)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 4: Valida√ß√£o Externa                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Determinar roteamento:                                   ‚îÇ
‚îÇ    - CODPRODU IN (6814,7701,7709) ‚Üí CNOUA                   ‚îÇ
‚îÇ    - NUM_CONTRATO > 0 ‚Üí SIPUA                               ‚îÇ
‚îÇ    - Sen√£o ‚Üí SIMDA                                          ‚îÇ
‚îÇ  ‚Ä¢ Chamar servi√ßo externo (timeout 10s)                     ‚îÇ
‚îÇ  ‚Ä¢ Verificar EZERT8 == '00000000'                           ‚îÇ
‚îÇ  ‚ùå Falha valida√ß√£o ‚Üí Retornar erro, ABORTAR                ‚îÇ
‚îÇ  ‚ùå Timeout/indispon√≠vel ‚Üí Retry 3x, ABORTAR                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 5: BEGIN TRANSACTION                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 6: Criar Hist√≥rico de Pagamento (THISTSIN)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INSERT INTO THISTSIN:                                      ‚îÇ
‚îÇ  ‚Ä¢ OPERACAO = 1098 (fixo)                                   ‚îÇ
‚îÇ  ‚Ä¢ DTMOVTO = data comercial (TSISTEMA)                      ‚îÇ
‚îÇ  ‚Ä¢ HORAOPER = hora atual sistema                            ‚îÇ
‚îÇ  ‚Ä¢ TIPCRR = '5' (fixo)                                      ‚îÇ
‚îÇ  ‚Ä¢ VALPRI, CRRMON, VALPRIBT, CRRMONBT, VALTOTBT            ‚îÇ
‚îÇ  ‚Ä¢ SITCONTB = '0', SITUACAO = '0'                           ‚îÇ
‚îÇ  ‚Ä¢ EZEUSRID = usu√°rio autenticado                           ‚îÇ
‚îÇ  ‚Ä¢ OCORHIST = TMESTSIN.OCORHIST + 1 (novo)                  ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí ROLLBACK, retornar erro                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 7: Atualizar Mestre (TMESTSIN)                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  UPDATE TMESTSIN:                                           ‚îÇ
‚îÇ  ‚Ä¢ TOTPAG += VALTOTBT                                       ‚îÇ
‚îÇ  ‚Ä¢ OCORHIST += 1                                            ‚îÇ
‚îÇ  ‚Ä¢ UPDATED_BY, UPDATED_AT                                   ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí ROLLBACK, retornar erro                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 8: Criar Acompanhamento (SI_ACOMPANHA_SINI)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  INSERT INTO SI_ACOMPANHA_SINI:                             ‚îÇ
‚îÇ  ‚Ä¢ COD_EVENTO = 1098                                        ‚îÇ
‚îÇ  ‚Ä¢ DATA_MOVTO_SINIACO = data comercial                      ‚îÇ
‚îÇ  ‚Ä¢ COD_USUARIO = usu√°rio autenticado                        ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí ROLLBACK, retornar erro                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 9: Atualizar Fases (SI_SINISTRO_FASE)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚Ä¢ Query SI_REL_FASE_EVENTO (WHERE COD_EVENTO=1098)         ‚îÇ
‚îÇ  ‚Ä¢ Para cada relacionamento:                                ‚îÇ
‚îÇ    - IND_ALTERACAO_FASE='1' ‚Üí ABRIR fase (9999-12-31)      ‚îÇ
‚îÇ    - IND_ALTERACAO_FASE='2' ‚Üí FECHAR fase (data atual)     ‚îÇ
‚îÇ  ‚ùå Falha ‚Üí ROLLBACK, retornar erro                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ETAPA 10: COMMIT TRANSACTION                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì OK
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ SUCESSO                                                  ‚îÇ
‚îÇ  ‚Ä¢ Retornar confirma√ß√£o                                     ‚îÇ
‚îÇ  ‚Ä¢ Exibir dados atualizados (novo saldo, hist√≥rico)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**F2.3: Tratamento de Erros e Rollback**

```csharp
public async Task<Result<PaymentAuthorizationResult>> AuthorizeAsync(
    PaymentAuthorizationCommand command)
{
    using var transaction = await _unitOfWork.BeginTransactionAsync();

    try
    {
        // Etapas 1-4: Valida√ß√£o e prepara√ß√£o
        var validationResult = await ValidateAsync(command);
        if (!validationResult.IsSuccess)
            return Result.Failure<PaymentAuthorizationResult>(
                validationResult.Error);

        // Etapas 5-10: Transa√ß√£o at√¥mica
        await CreateHistoryAsync(command, validationResult.Value);
        await UpdateClaimMasterAsync(command);
        await CreateAccompanimentAsync(command);
        await UpdatePhasesAsync(command);

        await transaction.CommitAsync();

        return Result.Success(new PaymentAuthorizationResult { ... });
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync();
        _logger.LogError(ex, "Falha na autoriza√ß√£o de pagamento");
        return Result.Failure<PaymentAuthorizationResult>(
            "Erro ao processar autoriza√ß√£o. Nenhuma altera√ß√£o foi realizada.");
    }
}
```

#### Interface (React)

**Componente:** `PaymentAuthorization.tsx`

```tsx
const PaymentAuthorizationForm: React.FC<Props> = ({ claim }) => {
  const { register, handleSubmit, watch, formState } = useForm<FormData>({
    resolver: zodResolver(paymentSchema),
  });

  const valorPrincipal = watch('valorPrincipal');
  const saldoPendente = claim.sdopag - claim.totpag;

  // Valida√ß√£o em tempo real: valor ‚â§ saldo pendente
  useEffect(() => {
    if (valorPrincipal > saldoPendente) {
      setError('valorPrincipal', {
        message: 'Valor Superior ao Saldo Pendente',
      });
    }
  }, [valorPrincipal, saldoPendente]);

  const mutation = useMutation({
    mutationFn: claimService.authorizePayment,
    onSuccess: () => {
      toast.success('Pagamento autorizado com sucesso!');
      queryClient.invalidateQueries(['claim', claim.id]);
    },
    onError: (error) => {
      toast.error(error.message);
    },
  });

  return (
    <form onSubmit={handleSubmit(mutation.mutate)}>
      {/* Campos do formul√°rio */}
      {/* Valida√ß√µes em tempo real */}
      {/* Loading state durante processamento */}
    </form>
  );
};
```

**Estados da UI:**
- **Idle:** Formul√°rio vazio, bot√£o "Autorizar" desabilitado
- **Validating:** Valida√ß√£o em tempo real, erros exibidos
- **Valid:** Formul√°rio v√°lido, bot√£o "Autorizar" habilitado
- **Submitting:** Loading spinner, bot√£o desabilitado, "Processando..."
- **Success:** Toast de sucesso, formul√°rio reseta, dados atualizados
- **Error:** Toast de erro, formul√°rio permanece preenchido

#### Testes

**Unit√°rios (Backend):**
- ‚úÖ Valida√ß√£o de tipo pagamento (1-5)
- ‚úÖ Valida√ß√£o valor ‚â§ saldo pendente
- ‚úÖ Valida√ß√£o benefici√°rio obrigat√≥rio (TPSEGU ‚â† 0)
- ‚úÖ C√°lculo convers√£o BTNF (precis√£o 8 ‚Üí 2 decimais)
- ‚úÖ Roteamento valida√ß√£o (CNOUA/SIPUA/SIMDA)
- ‚úÖ Rollback quando valida√ß√£o externa falha
- ‚úÖ Rollback quando insert hist√≥rico falha
- ‚úÖ Rollback quando update mestre falha
- ‚úÖ Rollback quando update fases falha

**Integra√ß√£o:**
- ‚úÖ Pipeline completo de autoriza√ß√£o
- ‚úÖ Transa√ß√£o at√¥mica (ACID)
- ‚úÖ Chamadas externas com Polly (retry, circuit breaker)
- ‚úÖ Hist√≥rico criado corretamente
- ‚úÖ Saldo atualizado corretamente
- ‚úÖ Fases atualizadas conforme configura√ß√£o

**E2E (Playwright):**
- ‚úÖ Usu√°rio pode autorizar pagamento v√°lido
- ‚úÖ Erro exibido quando valor excede saldo
- ‚úÖ Benefici√°rio obrigat√≥rio para tipo seguro espec√≠fico
- ‚úÖ Loading exibido durante processamento
- ‚úÖ Sucesso exibido ap√≥s autoriza√ß√£o
- ‚úÖ Hist√≥rico atualizado na tela

---

### 4.3 User Story 3: Hist√≥rico de Pagamentos

**Prioridade:** P3 (Important - Should Have)
**Complexidade:** Baixa
**Pontos de Fun√ß√£o:** 8 PF

#### Funcionalidades

**F3.1: Listagem de Hist√≥rico**
- **Query:** `SELECT * FROM THISTSIN WHERE (chave sinistro) ORDER BY OCORHIST DESC`
- **Pagina√ß√£o:** 20 registros por p√°gina (configur√°vel at√© 100)
- **Ordena√ß√£o:** OCORHIST descendente (mais recente primeiro)
- **Performance:** < 500ms para 1000+ registros (index cobridor)

**Colunas Exibidas:**
- Data (DTMOVTO) - formato DD/MM/YYYY
- Hora (HORAOPER) - formato HH:MM:SS
- Valor Principal (VALPRI) - formatado R$ #.###,##
- Valor Corre√ß√£o (CRRMON) - formatado R$ #.###,##
- Total (VALTOTBT) - formatado R$ #.###,## (em BTNF)
- Benefici√°rio (NOMFAV)
- Operador (EZEUSRID)
- Status Cont√°bil (SITCONTB)
- Situa√ß√£o (SITUACAO)

**F3.2: Filtros e Busca**
- Filtro por data (range)
- Filtro por operador
- Filtro por status cont√°bil
- Busca por benefici√°rio (LIKE)

**F3.3: Exporta√ß√£o**
- Exportar para Excel (XLSX)
- Exportar para CSV
- Exportar para PDF (relat√≥rio formatado)

#### Interface (React)

```tsx
const PaymentHistory: React.FC<{ claimId: string }> = ({ claimId }) => {
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(20);

  const { data, isLoading } = useQuery({
    queryKey: ['payment-history', claimId, page, pageSize],
    queryFn: () => claimService.getPaymentHistory(claimId, page, pageSize),
    keepPreviousData: true,
  });

  return (
    <div className="payment-history">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Hora</th>
            <th>Valor</th>
            <th>Benefici√°rio</th>
            <th>Operador</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {data?.items.map(payment => (
            <tr key={payment.ocorhist}>
              <td>{formatDate(payment.dtmovto)}</td>
              <td>{payment.horaoper}</td>
              <td>{formatCurrency(payment.valtotbt)}</td>
              <td>{payment.nomfav}</td>
              <td>{payment.ezeusrid}</td>
              <td>{getStatusLabel(payment.situacao)}</td>
            </tr>
          ))}
        </tbody>
      </table>
      <Pagination
        current={page}
        total={data?.totalPages}
        onChange={setPage}
      />
    </div>
  );
};
```

---

### 4.4 User Story 4: Produtos Especiais (Cons√≥rcio)

**Prioridade:** P4 (Nice to Have - Could Have)
**Complexidade:** M√©dia
**Pontos de Fun√ß√£o:** 10 PF

*(Detalhamento similar √†s anteriores)*

---

### 4.5 User Story 5: Gest√£o de Fases e Workflow

**Prioridade:** P5 (Nice to Have - Could Have)
**Complexidade:** M√©dia
**Pontos de Fun√ß√£o:** 12 PF

*(Detalhamento similar √†s anteriores)*

---

### 4.6 User Story 6: Dashboard de Migra√ß√£o

**Prioridade:** P6 (Monitoring - Should Have)
**Complexidade:** M√©dia
**Pontos de Fun√ß√£o:** 15 PF

*(Detalhamento similar √†s anteriores)*

---

## 5. Comparativo: Legado vs Proposto

### 5.1 Arquitetura

| Aspecto | Legado (VisualAge) | Proposto (.NET 9 + React) |
|---------|-------------------|---------------------------|
| **Camada Apresenta√ß√£o** | Terminal 3270, CICS Maps | React 19 SPA, Responsivo |
| **Camada Neg√≥cio** | COBOL/EZEE Monol√≠tico | C# Microservices, Clean Arch |
| **Camada Dados** | DB2 com SQL embutido | EF Core, Repository Pattern |
| **Integra√ß√µes** | CICS Link, MQ | REST/SOAP com Polly |
| **Autentica√ß√£o** | RACF Mainframe | JWT + Azure AD |
| **Logging** | CICS Logs | Serilog estruturado |
| **Monitoramento** | CICS Region Stats | Application Insights |

### 5.2 Performance

| Opera√ß√£o | Legado | Proposto | Melhoria |
|----------|--------|----------|----------|
| **Busca Sinistro** | 2-4s | < 3s | ‚úÖ Similar |
| **Autoriza√ß√£o** | 60-90s | < 90s | ‚úÖ Similar |
| **Hist√≥rico (1000 reg)** | 1-2s | < 500ms | ‚úÖ 50-75% mais r√°pido |
| **Throughput** | 500 tx/h | 1000+ tx/h | ‚úÖ 100% aumento |
| **Usu√°rios Concorrentes** | 50 | 200+ | ‚úÖ 4x mais |

### 5.3 Custos (Estimado - Anual)

| Item | Legado | Proposto | Economia |
|------|--------|----------|----------|
| **Licen√ßas CICS** | R$ 500k | R$ 0 | R$ 500k |
| **Licen√ßas DB2** | R$ 200k | R$ 80k (SQL Srv) | R$ 120k |
| **Mainframe MIPS** | R$ 300k | R$ 0 | R$ 300k |
| **Infra Cloud** | R$ 0 | R$ 150k (Azure) | -R$ 150k |
| **Manuten√ß√£o** | R$ 400k | R$ 200k | R$ 200k |
| **TOTAL** | **R$ 1.4M** | **R$ 430k** | **R$ 970k (69%)** |

---

*(Este documento ser√° continuado em parte 2 com An√°lise de Pontos de Fun√ß√£o, Esfor√ßo e Cronograma)*

**FIM DA PARTE 1/6 - SISTEMA PROPOSTO**
